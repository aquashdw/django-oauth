{% extends 'base.html' %}

{% block content %}
<section class="mt-6 px-6">
  <div class="title level is-mobile mb-1">
    <div class="level-left">
      <div class="level-item">
        <div>
          <p class="title is-1">{{ client.name }} <button class="tag is-info" id="modal-open-button">Rename</button></p>
          <p id="rename-result-msg" class="subtitle is-6 is-invisible">&nbsp;</p>
        </div>
      </div>
    </div>
    <div class="level-right">
      <a class="button is-info" href="{% url 'oauth:index' %}">Back</a>
    </div>
  </div>
  <div class="level is-mobile">
    <div class="level-left">
      <div class="level-item">
        <p class="subtitle">Status: <span class="tag is-medium is-warning">{{ client.get_status_display }}</span></p>
      </div>
    </div>
  </div>
  <div class="level is-mobile">
    <div class="level-left">
      <div class="level-item">
        <p class="subtitle">Client ID: <code class="is-hidden-mobile">{{ client.client_id }}</code> <button data-dj-value="{{ client.client_id }}" class="copy-btn tag">Copy</button></p>
      </div>
    </div>
  </div>
  <div class="level is-mobile">
    <div class="level-left">
      <div class="level-item">
        <p class="subtitle">Client Secret: <code id="client-secret" class="is-hidden-mobile" data-dj-value="{{ client.client_secret }}">******* Click to reveal ********</code> <button data-dj-value="{{ client.client_secret }}" class="copy-btn tag">Copy</button></p>
      </div>
    </div>
  </div>
</section>
<hr>
<section class="columns">
  <div class="column">
    <section class="mx-5 block has-text-centered">
      <h2 class="title mb-2">Callback URLs</h2>
      <p class="subtitle">URLs to notify user's approval</p>
      {% comment %} add url form {% endcomment %}
      <form class="mb-3" action="{% url 'oauth:callback_add' client.pk %}" method="post">
        {% csrf_token %}
        <div class="field has-addons">
          <div class="control is-expanded">
            <input class="input" type="url" name="url" required>
          </div>
          <div class="control">
            <button class="button is-info" type="submit" {% if not callback_urls|length < 4 %}disabled{% endif %}>Add</button>
          </div>
        </div>
      </form>
      {% if callback_urls %}
      <table class="table is-fullwidth">
        <thead>
          <th class="has-text-left">Callback URLs</th>
          <td class="has-text-right">Action</td>
        </thead>
        <tbody>
          {% for url in callback_urls %}
          <tr>
            <td class="has-text-left">{{ url.url }}</td>
            {% comment %} remove form {% endcomment %}
            <td class="has-text-right">
              <form action="{% url 'oauth:callback_remove' client.pk url.pk %}" method="post">
                {% csrf_token %}
                <button class="tag is-danger is-light" type="submit">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="is-size-5 has-text-warning">No Callback URLs set</h3>
      {% endif %}
      <p id="callback-msg" class="is-invisible"></p>
    </section>
  </div>
  <div class="column">
    <section class="mx-5 has-text-centered">
      <h2 class="title mb-2">Testers</h2>
      <p class="subtitle">Users allowed before open</p>
      {% comment %} add user form {% endcomment %}
      <form class="mb-3" action="{% url 'oauth:testuser_add' client.pk %}" method="post">
        {% csrf_token %}
        <div class="field has-addons">
          <div class="control is-expanded">
            <input class="input" type="email" name="email" required>
          </div>
          <div class="control">
            <button class="button is-info" type="submit" {% if not test_users|length < 10 %}disabled{% endif %}>Add</button>
          </div>
        </div>
      </form>
      {% if test_users %}
      <table class="table is-fullwidth">
        <thead>
          <th class="has-text-left">Testers</th>
          <td class="has-text-right">Action</td>
        </thead>
        <tbody>
          {% for tester in test_users %}
          <tr>
            <td class="has-text-left">{{ tester.email }}</td>
            <td class="has-text-right">
              <form action="{% url 'oauth:testuser_remove' client.pk %}" method="post">
                {% csrf_token %}
                <input type="hidden" name="email" value="{{ tester.email }}">
                <button class="tag is-danger is-light" type="submit">Remove</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="is-size-5 has-text-warning">No testers invited</h3>
      {% endif %}
      <p id="testuser-msg" class="is-invisible"></p>
    </section>
  </div>
</section>
<hr>
<section class="block px-6">
  <a class="button is-clickable is-danger" href="{% url 'oauth:delete' client.pk %}">Delete</a>
</section>
{% comment %} modal {% endcomment %}
<div id="rename-client-modal" class="modal">
  <div class="modal-background"></div>
  <div class="modal-content">
    <div class="box mx-3">
      <div class="level">
        <div class="level-left">
          <div class="level-item">
            <p class="title is-4">Rename Client</p>
          </div>
        </div>
        <div class="level-right">
          <div class="level-item">
            <button id="modal-close-button" class="delete" aria-label="close"></button>
          </div>
        </div>
      </div>
      
      <form class="mb-3" action="{% url 'oauth:update' client.pk %}" method="post">
        {% csrf_token %}
        <div class="field has-addons">
          <div class="control is-expanded">
            <input class="input" type="text" name="name" required>
          </div>
          <div class="control">
            <button class="button is-info" type="input">Rename</button>
          </div>
        </div>
      </form>
      <!-- Your content -->
    </div>
  </div>
</div>

{% endblock content %}

{% block script %}
{% comment %} rename client {% endcomment %}
<script>
const modal = document.getElementById('rename-client-modal')

const openModal = () => modal.classList.add('is-active')
const closeModal = () => modal.classList.remove('is-active')

document.getElementById('modal-open-button').addEventListener('click', openModal)
document.querySelector('.modal-background').addEventListener('click', closeModal)
document.getElementById('modal-close-button').addEventListener('click', closeModal)
document.addEventListener('keydown', (event) => {
  if(event.key === "Escape") {
    closeModal();
  }
});
const renameSuccess = urlParams.get('rename')
const error = urlParams.get('errors')
if (renameSuccess || error === 'clientname') {
  const renameResultMsg = document.getElementById('rename-result-msg')
  renameResultMsg.innerText = renameSuccess ? 'Rename Success!!!' : 'Rename Failed.'
  renameResultMsg.classList.add(renameSuccess ? 'has-text-success' : 'has-text-danger')
  renameResultMsg.classList.toggle('is-invisible')
  setTimeout(() => {
    renameResultMsg.classList.toggle('is-invisible')
  }, 3000)
}
</script>

{% comment %} callback urls {% endcomment %}
<script>
const callback = urlParams.get('callback')
if (callback) {
  const callbackMsg = document.getElementById('callback-msg')
  if (callback === 'add') {
    callbackMsg.innerText = 'URL added'
    callbackMsg.classList.add('has-text-success')
  }
  else if (callback === 'remove') {
    callbackMsg.innerText = 'URL removed'
    callbackMsg.classList.add('has-text-warning')
  }
  else if (callback === 'exceed_limit') {
    callbackMsg.innerText = 'Maximum of 4 URLs allowed'
    callbackMsg.classList.add('has-text-danger')
  }
  else {
    callbackMsg.innerText = 'Error: Check for duplicates'
    callbackMsg.classList.add('has-text-danger')
  }
  
  callbackMsg.classList.toggle('is-invisible')
  setTimeout(() => {
    callbackMsg.classList.toggle('is-invisible')
  }, 3000)
}
</script>

{% comment %} test users {% endcomment %}
<script>
const testuser = urlParams.get('testuser')
if (testuser) {
  const testuserMsg = document.getElementById('testuser-msg')
  if (testuser === 'add') {
    testuserMsg.innerText = 'Test user added'
    testuserMsg.classList.add('has-text-success')
  }
  else if (testuser === 'remove') {
    testuserMsg.innerText = 'Test user removed'
    testuserMsg.classList.add('has-text-warning')}
  else if (testuser === 'exceed_limit') {
    testuserMsg.innerText = 'Maximum of 10 Users allowed'
    testuserMsg.classList.add('has-text-danger')}
  else if (testuser === 'duplicate') {
    testuserMsg.innerText = 'User already added'
    testuserMsg.classList.add('has-text-danger')}
  else if (testuser === 'not_found') {
    testuserMsg.innerText = 'User not found'
    testuserMsg.classList.add('has-text-danger')
  }
  else {
    testuserMsg.innerText = 'Error'
    testuserMsg.classList.add('has-text-danger')
  }

  testuserMsg.classList.toggle('is-invisible')
  setTimeout(() => {
    testuserMsg.classList.toggle('is-invisible')
  }, 3000)
}
</script>

{% comment %} client keys {% endcomment %}
<script>
document.querySelectorAll('.copy-btn').forEach(button => button.addEventListener('click', (event) => {
  navigator.clipboard.writeText(event.target.dataset.djValue)
  event.target.innerText = 'Copied!'
  setTimeout(() => {
    event.target.innerText = 'Copy'
  }, 3000)
}))

let clientSecretHolder = document.getElementById('client-secret')
let masked = true
clientSecretHolder.addEventListener('click', (event) => {
  if (masked) clientSecretHolder.innerText = clientSecretHolder.dataset.djValue
  else clientSecretHolder.innerText = '******* Click to reveal ********'
  masked = !masked
})
</script>
{% endblock script %}
